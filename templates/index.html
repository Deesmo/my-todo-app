<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Brad's To Do List</title>
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Brad's ToDo">
<link rel="manifest" href="/static/manifest.json">
<link rel="apple-touch-icon" href="/static/icon-192.png">
<style>
  :root {
    --high: #ff6b6b;
    --high-glow: rgba(255,107,107,.35);
    --medium: #ffa94d;
    --medium-glow: rgba(255,169,77,.35);
    --low: #69db7c;
    --low-glow: rgba(105,219,124,.35);
    --glass: rgba(255,255,255,.12);
    --glass-border: rgba(255,255,255,.18);
    --glass-strong: rgba(255,255,255,.18);
    --glass-input: rgba(255,255,255,.08);
    --text: #f0f0f5;
    --text-secondary: rgba(240,240,245,.7);
    --text-muted: rgba(240,240,245,.45);
    --radius: 16px;
    --radius-sm: 12px;
    --blur: blur(20px);
    --blur-strong: blur(40px);
    --transition: .25s cubic-bezier(.4,0,.2,1);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
    min-height: 100vh; min-height: 100dvh;
    color: var(--text);
    background: #0f0c29;
    background: linear-gradient(135deg, #0f0c29 0%, #1a1a3e 30%, #24243e 50%, #1b1340 70%, #0f0c29 100%);
    background-attachment: fixed;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }
  /* Ambient background orbs */
  body::before, body::after {
    content: ""; position: fixed; border-radius: 50%; pointer-events: none; z-index: 0;
    filter: blur(80px); opacity: .4;
  }
  body::before {
    width: 400px; height: 400px; top: -100px; right: -100px;
    background: radial-gradient(circle, rgba(108,92,231,.6), transparent 70%);
    animation: orbFloat 20s ease-in-out infinite alternate;
  }
  body::after {
    width: 350px; height: 350px; bottom: -80px; left: -80px;
    background: radial-gradient(circle, rgba(162,155,254,.5), transparent 70%);
    animation: orbFloat 25s ease-in-out infinite alternate-reverse;
  }
  @keyframes orbFloat {
    0% { transform: translate(0,0) scale(1); }
    50% { transform: translate(30px, -20px) scale(1.1); }
    100% { transform: translate(-20px, 30px) scale(.95); }
  }

  .container {
    max-width: 640px; margin: 0 auto; padding: 20px 16px 100px;
    position: relative; z-index: 1;
  }

  /* Header */
  .app-header {
    display: flex; align-items: center; gap: 14px; margin-bottom: 28px; padding: 4px 0;
  }
  .app-logo {
    width: 44px; height: 44px; border-radius: 14px;
    background: linear-gradient(135deg, rgba(108,92,231,.8), rgba(162,155,254,.8));
    backdrop-filter: var(--blur);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 16px rgba(108,92,231,.4), inset 0 1px 0 rgba(255,255,255,.2);
    flex-shrink: 0; border: 1px solid rgba(255,255,255,.15);
  }
  .app-logo svg { width: 22px; height: 22px; }
  .app-title {
    font-size: 1.6rem; font-weight: 700; letter-spacing: -.02em;
    background: linear-gradient(135deg, #fff, rgba(162,155,254,.9));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .app-subtitle { font-size: .78rem; color: var(--text-muted); font-weight: 500; margin-top: 2px; letter-spacing: .02em; }

  /* Glass panel mixin */
  .glass {
    background: var(--glass);
    backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
    border: 1px solid var(--glass-border);
    box-shadow: 0 8px 32px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.06);
  }

  /* Add form */
  .add-form {
    display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
    padding: 16px; border-radius: var(--radius);
    background: var(--glass-strong);
    backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
    border: 1px solid var(--glass-border);
    box-shadow: 0 8px 32px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.08);
  }
  .add-form input[type="text"] {
    flex: 1 1 200px; padding: 11px 16px; border: 1px solid rgba(255,255,255,.1);
    border-radius: var(--radius-sm); font-size: .95rem; outline: none;
    background: var(--glass-input); color: var(--text);
    transition: all var(--transition);
  }
  .add-form input[type="text"]:focus {
    border-color: rgba(108,92,231,.6);
    box-shadow: 0 0 0 3px rgba(108,92,231,.15), 0 0 20px rgba(108,92,231,.1);
  }
  .add-form input[type="text"]::placeholder { color: var(--text-muted); }
  .add-form select, .add-form input[type="datetime-local"] {
    padding: 11px 12px; border: 1px solid rgba(255,255,255,.1);
    border-radius: var(--radius-sm); font-size: .88rem;
    background: var(--glass-input); color: var(--text);
    outline: none; transition: all var(--transition);
  }
  .add-form select option { background: #24243e; color: #f0f0f5; }
  .add-form select:focus, .add-form input[type="datetime-local"]:focus {
    border-color: rgba(108,92,231,.6);
  }
  .add-form button {
    padding: 11px 28px; border: none; border-radius: var(--radius-sm);
    background: linear-gradient(135deg, #6c5ce7, #a29bfe);
    color: #fff; font-size: .95rem; cursor: pointer; font-weight: 600;
    transition: all var(--transition);
    box-shadow: 0 4px 16px rgba(108,92,231,.35), inset 0 1px 0 rgba(255,255,255,.15);
    position: relative; overflow: hidden;
  }
  .add-form button::after {
    content: ""; position: absolute; inset: 0;
    background: linear-gradient(135deg, transparent, rgba(255,255,255,.1));
    opacity: 0; transition: opacity var(--transition);
  }
  .add-form button:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(108,92,231,.45); }
  .add-form button:hover::after { opacity: 1; }
  .add-form button:active { transform: translateY(0); }

  /* Notify button */
  .notify-btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 7px 16px; border: 1px solid var(--glass-border);
    border-radius: 999px; cursor: pointer;
    font-size: .78rem; color: var(--text-secondary); margin-bottom: 18px;
    transition: all var(--transition);
    background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
  }
  .notify-btn:hover { border-color: rgba(108,92,231,.5); color: #a29bfe; box-shadow: 0 0 16px rgba(108,92,231,.15); }
  .notify-btn.granted {
    background: rgba(108,92,231,.15); border-color: rgba(108,92,231,.4);
    color: #a29bfe; cursor: default;
  }

  /* Tabs */
  .tabs { display: flex; gap: 8px; margin-bottom: 22px; flex-wrap: wrap; }
  .tab {
    padding: 8px 20px; border: 1px solid var(--glass-border); border-radius: 999px;
    cursor: pointer; font-size: .83rem; font-weight: 600;
    transition: all var(--transition); color: var(--text-secondary);
    user-select: none; -webkit-tap-highlight-color: transparent;
    background: var(--glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
  }
  .tab:hover { border-color: rgba(255,255,255,.3); color: var(--text); }
  .tab.active {
    background: linear-gradient(135deg, rgba(108,92,231,.7), rgba(162,155,254,.5));
    color: #fff; border-color: rgba(162,155,254,.4);
    box-shadow: 0 4px 16px rgba(108,92,231,.3), inset 0 1px 0 rgba(255,255,255,.1);
  }
  .tab[data-filter="high"].active {
    background: linear-gradient(135deg, rgba(255,107,107,.6), rgba(238,90,36,.4));
    border-color: rgba(255,107,107,.3); box-shadow: 0 4px 16px var(--high-glow);
  }
  .tab[data-filter="medium"].active {
    background: linear-gradient(135deg, rgba(255,169,77,.6), rgba(243,156,18,.4));
    border-color: rgba(255,169,77,.3); box-shadow: 0 4px 16px var(--medium-glow);
  }
  .tab[data-filter="low"].active {
    background: linear-gradient(135deg, rgba(105,219,124,.5), rgba(32,191,107,.4));
    border-color: rgba(105,219,124,.3); box-shadow: 0 4px 16px var(--low-glow);
  }

  /* Task list */
  .task-list { display: flex; flex-direction: column; gap: 10px; }

  /* Task card */
  .task-card {
    display: flex; align-items: center; gap: 12px; padding: 14px 16px;
    border-radius: var(--radius);
    border-left: 4px solid var(--medium);
    transition: all var(--transition);
    -webkit-tap-highlight-color: transparent;
    animation: slideIn .35s cubic-bezier(.4,0,.2,1) both;
    background: var(--glass);
    backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
    border-top: 1px solid rgba(255,255,255,.08);
    border-right: 1px solid rgba(255,255,255,.05);
    border-bottom: 1px solid rgba(255,255,255,.03);
    box-shadow: 0 4px 24px rgba(0,0,0,.15);
  }
  .task-card:hover {
    box-shadow: 0 8px 32px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.08);
    transform: translateY(-2px);
    background: rgba(255,255,255,.15);
  }
  .task-card:active { transform: translateY(0); }
  .task-card.high { border-left-color: var(--high); }
  .task-card.medium { border-left-color: var(--medium); }
  .task-card.low { border-left-color: var(--low); }
  .task-card.done { opacity: .5; }
  .task-card.done:hover { opacity: .65; }
  .task-card.done .task-desc { text-decoration: line-through; color: var(--text-muted); }

  /* Animations */
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(12px) scale(.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  @keyframes slideOut {
    from { opacity: 1; transform: translateX(0); max-height: 120px; margin-bottom: 10px; }
    to { opacity: 0; transform: translateX(80px); max-height: 0; margin-bottom: 0; padding: 0; overflow: hidden; }
  }
  @keyframes completePulse {
    0% { box-shadow: 0 4px 24px rgba(0,0,0,.15); }
    50% { box-shadow: 0 0 0 6px rgba(105,219,124,.25), 0 0 30px rgba(105,219,124,.15); }
    100% { box-shadow: 0 4px 24px rgba(0,0,0,.15); }
  }
  .task-card.completing { animation: completePulse .6s ease; }
  .task-card.deleting { animation: slideOut .35s ease forwards; pointer-events: none; }

  /* Custom checkbox */
  .check-wrap { position: relative; width: 24px; height: 24px; flex-shrink: 0; }
  .check-wrap input {
    opacity: 0; position: absolute; width: 100%; height: 100%;
    cursor: pointer; z-index: 1; margin: 0;
  }
  .check-mark {
    width: 24px; height: 24px; border: 2px solid rgba(255,255,255,.2); border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    transition: all var(--transition); background: rgba(255,255,255,.05);
  }
  .check-mark svg {
    width: 13px; height: 13px; opacity: 0; transition: all var(--transition);
    stroke: #fff; stroke-width: 2.5; fill: none;
  }
  .check-wrap input:checked + .check-mark {
    background: linear-gradient(135deg, #69db7c, #20bf6b); border-color: transparent;
    box-shadow: 0 2px 10px rgba(105,219,124,.4);
  }
  .check-wrap input:checked + .check-mark svg { opacity: 1; transform: scale(1.1); }

  .task-body { flex: 1; min-width: 0; }
  .task-desc {
    font-size: .93rem; word-break: break-word; line-height: 1.45;
    font-weight: 500; transition: color var(--transition);
  }
  .task-meta { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; margin-top: 7px; }

  /* Glass priority badges */
  .badge {
    display: inline-flex; align-items: center; gap: 3px;
    font-size: .63rem; font-weight: 700; text-transform: uppercase; letter-spacing: .05em;
    padding: 3px 10px; border-radius: 999px; color: #fff;
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    border: 1px solid transparent;
  }
  .badge.high {
    background: rgba(255,107,107,.25); border-color: rgba(255,107,107,.3);
    color: #ff8a8a; box-shadow: 0 0 12px rgba(255,107,107,.1);
  }
  .badge.medium {
    background: rgba(255,169,77,.2); border-color: rgba(255,169,77,.3);
    color: #ffbb77; box-shadow: 0 0 12px rgba(255,169,77,.1);
  }
  .badge.low {
    background: rgba(105,219,124,.2); border-color: rgba(105,219,124,.3);
    color: #7fe09b; box-shadow: 0 0 12px rgba(105,219,124,.1);
  }

  /* Due date badges */
  .due-badge {
    display: inline-flex; align-items: center; gap: 3px;
    font-size: .63rem; font-weight: 600;
    padding: 3px 10px; border-radius: 999px;
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    border: 1px solid transparent;
  }
  .due-badge.overdue {
    background: rgba(255,107,107,.15); border-color: rgba(255,107,107,.25);
    color: #ff8a8a;
  }
  .due-badge.due-soon {
    background: rgba(255,169,77,.12); border-color: rgba(255,169,77,.25);
    color: #ffbb77;
  }
  .due-badge.due-later {
    background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.1);
    color: var(--text-muted);
  }

  /* Action buttons */
  .task-actions { display: flex; gap: 2px; flex-shrink: 0; }
  .task-actions button {
    background: none; border: none; border-radius: var(--radius-sm);
    padding: 7px 8px; cursor: pointer; color: var(--text-muted);
    transition: all var(--transition); display: flex; align-items: center; justify-content: center;
  }
  .task-actions button:hover { background: rgba(255,255,255,.08); color: var(--text); }
  .task-actions button.del:hover { background: rgba(255,107,107,.15); color: var(--high); }
  .task-actions button svg { width: 16px; height: 16px; }

  /* Empty state */
  .empty { text-align: center; padding: 56px 16px; }
  .empty-icon {
    width: 72px; height: 72px; margin: 0 auto 18px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: rgba(108,92,231,.15);
    border: 1px solid rgba(108,92,231,.25);
    box-shadow: 0 0 30px rgba(108,92,231,.1);
  }
  .empty-icon svg { width: 30px; height: 30px; stroke: #a29bfe; fill: none; stroke-width: 1.5; }
  .empty-title { font-size: 1.05rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
  .empty-sub { font-size: .85rem; color: var(--text-muted); }

  /* Loading skeleton */
  .skeleton { display: flex; flex-direction: column; gap: 10px; }
  .skeleton-card {
    height: 72px; border-radius: var(--radius);
    background: linear-gradient(90deg, rgba(255,255,255,.04) 25%, rgba(255,255,255,.08) 50%, rgba(255,255,255,.04) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.8s ease infinite;
    border: 1px solid rgba(255,255,255,.06);
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  /* Confetti */
  .confetti-container {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 200; overflow: hidden;
  }
  .confetti-piece { position: absolute; border-radius: 2px; }

  /* Offline banner */
  .offline-banner {
    display: none;
    background: linear-gradient(135deg, rgba(255,107,107,.9), rgba(238,90,36,.9));
    backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
    color: #fff; text-align: center;
    padding: 10px; font-size: .82rem; font-weight: 600;
    position: relative; z-index: 10;
  }
  .offline-banner.show { display: block; }

  /* Edit modal */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(15,12,41,.7);
    backdrop-filter: var(--blur-strong); -webkit-backdrop-filter: var(--blur-strong);
    justify-content: center; align-items: center; z-index: 100; padding: 16px;
  }
  .modal-overlay.open { display: flex; }
  .modal-overlay.open .modal { animation: modalIn .3s cubic-bezier(.4,0,.2,1); }
  @keyframes modalIn {
    from { opacity: 0; transform: scale(.92) translateY(16px); }
    to { opacity: 1; transform: none; }
  }
  .modal {
    border-radius: 20px; padding: 28px;
    width: 100%; max-width: 420px;
    background: rgba(36,36,62,.85);
    backdrop-filter: var(--blur-strong); -webkit-backdrop-filter: var(--blur-strong);
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: 0 24px 64px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.08);
  }
  .modal h2 {
    margin-bottom: 22px; font-size: 1.15rem; font-weight: 700;
    background: linear-gradient(135deg, #fff, #a29bfe);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .modal label { display: block; font-weight: 600; margin-bottom: 6px; font-size: .82rem; color: var(--text-secondary); }
  .modal input, .modal select {
    width: 100%; padding: 11px 14px; border: 1px solid rgba(255,255,255,.1);
    border-radius: var(--radius-sm); font-size: .93rem; margin-bottom: 16px; outline: none;
    background: rgba(255,255,255,.06); color: var(--text);
    transition: all var(--transition);
  }
  .modal select option { background: #24243e; color: #f0f0f5; }
  .modal input:focus, .modal select:focus {
    border-color: rgba(108,92,231,.5);
    box-shadow: 0 0 0 3px rgba(108,92,231,.12);
  }
  .modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 6px; }
  .modal-btns button {
    padding: 10px 22px; border: none; border-radius: var(--radius-sm);
    font-size: .9rem; cursor: pointer; font-weight: 600;
    transition: all var(--transition);
  }
  .btn-cancel {
    background: rgba(255,255,255,.08); color: var(--text-secondary);
    border: 1px solid rgba(255,255,255,.1);
  }
  .btn-cancel:hover { background: rgba(255,255,255,.12); }
  .btn-save {
    background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: #fff;
    box-shadow: 0 4px 16px rgba(108,92,231,.35), inset 0 1px 0 rgba(255,255,255,.15);
  }
  .btn-save:hover { box-shadow: 0 6px 24px rgba(108,92,231,.5); transform: translateY(-1px); }

  /* Touch & responsive */
  @media (hover: none) {
    .task-card:hover { transform: none; background: var(--glass); box-shadow: 0 4px 24px rgba(0,0,0,.15); }
    .task-card:active { transform: scale(.98); }
    .add-form button:hover { transform: none; }
  }
  @media (max-width: 480px) {
    .container { padding: 14px 12px 100px; }
    .add-form { padding: 12px; gap: 6px; }
    .task-actions button { padding: 8px 10px; }
    .app-title { font-size: 1.4rem; }
  }
</style>
</head>
<body>
<div class="offline-banner" id="offlineBanner">You are offline — tasks are read-only</div>
<div class="container">
  <div class="app-header">
    <div class="app-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 11 12 14 22 4"/>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
      </svg>
    </div>
    <div>
      <div class="app-title">Brad's To Do List</div>
      <div class="app-subtitle">Stay on top of things</div>
    </div>
  </div>

  <form class="add-form" id="addForm">
    <input type="text" id="descInput" placeholder="What needs to be done?" required>
    <select id="prioInput">
      <option value="high">High</option>
      <option value="medium" selected>Medium</option>
      <option value="low">Low</option>
    </select>
    <input type="datetime-local" id="dueInput" title="Due date (optional)">
    <button type="submit">Add Task</button>
  </form>

  <button class="notify-btn" id="notifyBtn" style="display:none">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    Enable Reminders
  </button>

  <div class="tabs" id="tabs">
    <button class="tab active" data-filter="all">All</button>
    <button class="tab" data-filter="high">High</button>
    <button class="tab" data-filter="medium">Medium</button>
    <button class="tab" data-filter="low">Low</button>
  </div>

  <div class="task-list" id="taskList">
    <div class="skeleton" id="skeleton">
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
    </div>
  </div>
</div>

<div class="confetti-container" id="confetti"></div>

<!-- Edit modal -->
<div class="modal-overlay" id="editOverlay">
  <div class="modal">
    <h2>Edit Task</h2>
    <input type="hidden" id="editId">
    <label for="editDesc">Description</label>
    <input type="text" id="editDesc" required>
    <label for="editPrio">Priority</label>
    <select id="editPrio">
      <option value="high">High</option>
      <option value="medium">Medium</option>
      <option value="low">Low</option>
    </select>
    <label for="editDue">Due Date</label>
    <input type="datetime-local" id="editDue">
    <div class="modal-btns">
      <button class="btn-cancel" id="editCancel">Cancel</button>
      <button class="btn-save" id="editSave">Save</button>
    </div>
  </div>
</div>

<script>
  const taskList = document.getElementById("taskList");
  const addForm = document.getElementById("addForm");
  const descInput = document.getElementById("descInput");
  const prioInput = document.getElementById("prioInput");
  const tabs = document.getElementById("tabs");
  const editOverlay = document.getElementById("editOverlay");
  const editId = document.getElementById("editId");
  const editDesc = document.getElementById("editDesc");
  const editPrio = document.getElementById("editPrio");
  const dueInput = document.getElementById("dueInput");
  const editDue = document.getElementById("editDue");
  const notifyBtn = document.getElementById("notifyBtn");
  const confettiEl = document.getElementById("confetti");

  const offlineBanner = document.getElementById("offlineBanner");

  let tasks = [];
  let filter = "all";
  let loaded = false;
  const notifiedIds = new Set();
  let notifyCheckInterval = null;

  function setOffline(offline) {
    offlineBanner.classList.toggle("show", offline);
  }
  window.addEventListener("online", () => { setOffline(false); loadTasks(); });
  window.addEventListener("offline", () => setOffline(true));
  if (!navigator.onLine) setOffline(true);

  async function loadTasks() {
    try {
      const res = await fetch("/api/tasks");
      tasks = await res.json();
    } catch {
      // offline — keep cached tasks
    }
    loaded = true;
    render();
  }

  function formatDue(dueDateStr) {
    if (!dueDateStr) return null;
    const due = new Date(dueDateStr);
    const now = new Date();
    const diffMs = due - now;
    const diffMins = diffMs / 60000;
    let cls;
    if (diffMs < 0) cls = "overdue";
    else if (diffMins <= 60) cls = "due-soon";
    else cls = "due-later";
    const opts = { month: "short", day: "numeric", hour: "numeric", minute: "2-digit" };
    const label = due.toLocaleString(undefined, opts);
    const prefix = cls === "overdue" ? "Overdue: " : "Due: ";
    return { cls, text: prefix + label };
  }

  const ICONS = {
    edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
    del: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
    clock: '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    check: '<svg viewBox="0 0 24 24"><polyline points="4 12 9 17 20 6"/></svg>',
  };

  function render() {
    const filtered = filter === "all" ? tasks : tasks.filter(t => t.priority === filter);
    if (!loaded) return;
    if (filtered.length === 0) {
      const isFiltered = filter !== "all";
      taskList.innerHTML = `
        <div class="empty">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24"><path d="${isFiltered
              ? "M3 6h18M3 12h18M3 18h18"
              : "M9 11l3 3L22 4M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
            }"/></svg>
          </div>
          <div class="empty-title">${isFiltered ? "No " + filter + " priority tasks" : "All clear!"}</div>
          <div class="empty-sub">${isFiltered ? "Try a different filter or add a new task" : "Add a task above to get started"}</div>
        </div>`;
      return;
    }
    taskList.innerHTML = filtered.map((t, i) => {
      const due = formatDue(t.due_date);
      const dueBadge = due
        ? `<span class="due-badge ${due.cls}">${ICONS.clock} ${esc(due.text)}</span>`
        : "";
      return `
      <div class="task-card ${t.priority}${t.completed ? " done" : ""}" data-id="${t.id}" style="animation-delay:${i * .03}s">
        <label class="check-wrap">
          <input type="checkbox" ${t.completed ? "checked" : ""} onchange="toggleComplete(${t.id})">
          <span class="check-mark">${ICONS.check}</span>
        </label>
        <div class="task-body">
          <div class="task-desc">${esc(t.description)}</div>
          <div class="task-meta">
            <span class="badge ${t.priority}">${t.priority}</span>${dueBadge}
          </div>
        </div>
        <div class="task-actions">
          <button onclick="openEdit(${t.id})" title="Edit">${ICONS.edit}</button>
          <button class="del" onclick="deleteTask(${t.id})" title="Delete">${ICONS.del}</button>
        </div>
      </div>`;
    }).join("");
  }

  function esc(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  // Celebration confetti
  function celebrate(x, y) {
    const colors = ["#6c5ce7","#a29bfe","#69db7c","#ffa94d","#ff6b6b","#fdcb6e","#74b9ff","#fff"];
    for (let i = 0; i < 30; i++) {
      const piece = document.createElement("div");
      piece.className = "confetti-piece";
      piece.style.left = x + "px";
      piece.style.top = y + "px";
      piece.style.background = colors[Math.floor(Math.random() * colors.length)];
      const w = Math.random() * 7 + 4;
      piece.style.width = w + "px";
      piece.style.height = (Math.random() > .4 ? w : w * 2.5) + "px";
      piece.style.borderRadius = Math.random() > .5 ? "50%" : "2px";
      const angle = Math.random() * Math.PI * 2;
      const velocity = Math.random() * 250 + 100;
      const vx = Math.cos(angle) * velocity;
      const vy = Math.sin(angle) * velocity - 200;
      piece.animate([
        { transform: "translate(0,0) rotate(0deg) scale(1)", opacity: 1 },
        { transform: `translate(${vx}px, ${vy + 250}px) rotate(${Math.random()*900-450}deg) scale(0)`, opacity: 0 }
      ], { duration: 900 + Math.random() * 500, easing: "cubic-bezier(.15,.46,.45,.94)" });
      confettiEl.appendChild(piece);
      setTimeout(() => piece.remove(), 1500);
    }
  }

  // Add task
  addForm.addEventListener("submit", async e => {
    e.preventDefault();
    const description = descInput.value.trim();
    if (!description) return;
    try {
      await fetch("/api/tasks", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({description, priority: prioInput.value, due_date: dueInput.value || null})
      });
      descInput.value = "";
      dueInput.value = "";
    } catch { alert("Cannot add tasks while offline"); }
    await loadTasks();
  });

  // Tabs
  tabs.addEventListener("click", e => {
    if (!e.target.classList.contains("tab")) return;
    tabs.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    e.target.classList.add("active");
    filter = e.target.dataset.filter;
    render();
  });

  // Toggle complete
  async function toggleComplete(id) {
    const task = tasks.find(t => t.id === id);
    const wasCompleted = task && task.completed;
    const card = document.querySelector(`.task-card[data-id="${id}"]`);
    if (card && !wasCompleted) {
      card.classList.add("completing");
      const rect = card.getBoundingClientRect();
      celebrate(rect.left + rect.width / 2, rect.top + rect.height / 2);
    }
    try {
      await fetch(`/api/tasks/${id}/complete`, {method: "PUT"});
    } catch { alert("Cannot update tasks while offline"); }
    await loadTasks();
  }

  // Delete with animation
  async function deleteTask(id) {
    const card = document.querySelector(`.task-card[data-id="${id}"]`);
    if (card) {
      card.classList.add("deleting");
      await new Promise(r => setTimeout(r, 320));
    }
    try {
      await fetch(`/api/tasks/${id}`, {method: "DELETE"});
    } catch { alert("Cannot delete tasks while offline"); }
    await loadTasks();
  }

  // Edit modal
  function openEdit(id) {
    const t = tasks.find(t => t.id === id);
    if (!t) return;
    editId.value = t.id;
    editDesc.value = t.description;
    editPrio.value = t.priority;
    editDue.value = t.due_date || "";
    editOverlay.classList.add("open");
  }

  document.getElementById("editCancel").addEventListener("click", () => {
    editOverlay.classList.remove("open");
  });

  editOverlay.addEventListener("click", e => {
    if (e.target === editOverlay) editOverlay.classList.remove("open");
  });

  document.getElementById("editSave").addEventListener("click", async () => {
    const id = editId.value;
    const description = editDesc.value.trim();
    if (!description) return;
    try {
      await fetch(`/api/tasks/${id}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({description, priority: editPrio.value, due_date: editDue.value || null})
      });
      editOverlay.classList.remove("open");
    } catch { alert("Cannot edit tasks while offline"); }
    await loadTasks();
  });

  // --- Notification System ---
  function initNotifications() {
    if (!("Notification" in window)) return;
    notifyBtn.style.display = "inline-flex";
    if (Notification.permission === "granted") {
      notifyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Reminders On';
      notifyBtn.classList.add("granted");
      startNotifyChecker();
    } else if (Notification.permission === "denied") {
      notifyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/><line x1="1" y1="1" x2="23" y2="23"/></svg> Blocked';
      notifyBtn.classList.add("granted");
    }
    notifyBtn.addEventListener("click", async () => {
      if (Notification.permission === "granted") return;
      const perm = await Notification.requestPermission();
      if (perm === "granted") {
        notifyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Reminders On';
        notifyBtn.classList.add("granted");
        startNotifyChecker();
      } else {
        notifyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/><line x1="1" y1="1" x2="23" y2="23"/></svg> Blocked';
        notifyBtn.classList.add("granted");
      }
    });
  }

  function startNotifyChecker() {
    if (notifyCheckInterval) return;
    notifyCheckInterval = setInterval(checkDueTasks, 60000);
    checkDueTasks();
  }

  function checkDueTasks() {
    if (Notification.permission !== "granted") return;
    const now = new Date();
    const window_ms = 5 * 60 * 1000;
    tasks.forEach(t => {
      if (!t.due_date || t.completed || notifiedIds.has(t.id)) return;
      const due = new Date(t.due_date);
      const diffMs = due - now;
      if (diffMs <= window_ms && diffMs > -window_ms) {
        notifiedIds.add(t.id);
        let body;
        if (diffMs <= 0) {
          body = "This task is now overdue!";
        } else {
          const mins = Math.ceil(diffMs / 60000);
          body = `Due in ${mins} minute${mins === 1 ? "" : "s"}`;
        }
        new Notification("Brad's To Do List", {
          body: `${t.description} - ${body}`,
          icon: "/static/icon-192.png",
          tag: `todo-${t.id}`,
        });
      }
    });
  }

  initNotifications();
  loadTasks();

  // Register service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/static/sw.js");
  }
</script>
</body>
</html>
